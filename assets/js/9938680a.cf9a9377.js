"use strict";(self.webpackChunkexperimenter_docs=self.webpackChunkexperimenter_docs||[]).push([[8077],{4137:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,l=e.originalType,s=e.parentName,u=r(e,["components","mdxType","originalType","parentName"]),d=p(n),c=i,h=d["".concat(s,".").concat(c)]||d[c]||m[c]||l;return n?a.createElement(h,o(o({ref:t},u),{},{components:n})):a.createElement(h,o({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=n.length,o=new Array(l);o[0]=c;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r[d]="string"==typeof e?e:i,o[1]=r;for(var p=2;p<l;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4300:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>f,frontMatter:()=>l,metadata:()=>r,toc:()=>p});var a=n(7462),i=(n(7294),n(4137));const l={id:"fml-spec",title:"The Feature Manifest Language",slug:"/fml-spec",sidebar_position:1},o=void 0,r={unversionedId:"deep-dives/specifications/fml/fml-spec",id:"deep-dives/specifications/fml/fml-spec",title:"The Feature Manifest Language",description:"About this document",source:"@site/docs/deep-dives/specifications/fml/fml-spec.mdx",sourceDirName:"deep-dives/specifications/fml",slug:"/fml-spec",permalink:"/fml-spec",draft:!1,editUrl:"https://github.com/mozilla/experimenter-docs/edit/main/docs/deep-dives/specifications/fml/fml-spec.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"fml-spec",title:"The Feature Manifest Language",slug:"/fml-spec",sidebar_position:1},sidebar:"sidebar",previous:{title:"Client SDK States & Lifecycle",permalink:"/client-sdk-states-and-lifecycle"},next:{title:"Using paths in FML",permalink:"/fml/fml-paths"}},s={},p=[{value:"About this document",id:"about-this-document",level:2},{value:"Introduction",id:"introduction",level:2},{value:"High level concepts",id:"high-level-concepts",level:2},{value:"JSON Merge Patch",id:"json-merge-patch",level:3},{value:"About the generated code",id:"about-the-generated-code",level:3},{value:"Recording exposure",id:"recording-exposure",level:3},{value:"Identifier cases",id:"identifier-cases",level:3},{value:"Introducing the FML",id:"introducing-the-fml",level:2},{value:"Features have <code>variables</code>",id:"features-have-variables",level:3},{value:"Enumerations",id:"enumerations",level:3},{value:"Feature defaults",id:"feature-defaults",level:2},{value:"Feature defaults and channels",id:"feature-defaults-and-channels",level:3},{value:"Additional types",id:"additional-types",level:2},{value:"Primitive types",id:"primitive-types",level:3},{value:"Bundle types",id:"bundle-types",level:3},{value:"Object types",id:"object-types",level:3},{value:"Structural types",id:"structural-types",level:3},{value:"Merging other FML files into this one",id:"merging-other-fml-files-into-this-one",level:2},{value:"Linking files from other components",id:"linking-files-from-other-components",level:2},{value:"Additional feature specific configuration",id:"additional-feature-specific-configuration",level:2},{value:"Links to documentation and contacts",id:"links-to-documentation-and-contacts",level:3},{value:"Feature co-enrollment",id:"feature-co-enrollment",level:3}],u=e=>function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,i.kt)("div",t)},d=u("Tabs"),m=u("TabItem"),c={toc:p},h="wrapper";function f(e){let{components:t,...n}=e;return(0,i.kt)(h,(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"about-this-document"},"About this document"),(0,i.kt)("p",null,"This document is the specification for the Feature Manifest Language for use with the Nimbus SDK. It is implemented by the ",(0,i.kt)("inlineCode",{parentName:"p"},"nimbus-fml")," tool, which is a Rust ",(0,i.kt)("a",{parentName:"p",href:"/fml/fml-cli"},"command line app run")," at build time of a mobile app."),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Nimbus is an experimentation platform to allow product owners to easily run experiments on their mobile apps."),(0,i.kt)("h2",{id:"high-level-concepts"},"High level concepts"),(0,i.kt)("p",null,"To the product owner, Nimbus allows you to experiment with different configurations of the application."),(0,i.kt)("p",null,"It does this by exposing a pre-determined proportion of the audience to different configurations of a feature. Once a winning configuration is identified, it can be rolled out to the rest of the audience, all without a re-release of the app."),(0,i.kt)("p",null,"To the app developer, ",(0,i.kt)("strong",{parentName:"p"},"Nimbus is a configuration store"),". Features are configured using data from Nimbus. Nimbus is updated at startup of each run."),(0,i.kt)("p",null,'The "Feature" in ',(0,i.kt)("a",{parentName:"p",href:"mobile-feature-api"},'"Feature API"'),' and "Feature Manifest" refers to'),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("em",{parentName:"p"},"An identifiable part of the app in which changes may be detectable by a user."))),(0,i.kt)("p",null,'The "Feature Manifest" is a schema to describe the structure of the configuration of these features, and a complete initial configuration for the app to use.'),(0,i.kt)("p",null,'The "Feature Manifest Language" is definition language for writing feature manifest.'),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"nimbus-fml")," is the name fo the tool for processing the feature manifest, to generate Swift and Kotlin and the JSON schema that Experimenter can ingest."),(0,i.kt)("p",null,"Features are configured remotely by sending JSON objects to the Nimbus SDK on each device. It is the job of the ",(0,i.kt)("inlineCode",{parentName:"p"},"nimbus-fml"),", and the code that it generates to unpack that JSON, validate it, coerce it into values usable by the app and recover if anything goes wrong."),(0,i.kt)("p",null,"At first glance, the FML might appear like a JSON deserializer like ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/google/gson/blob/master/UserGuide.md"},"Google GSON")," or ",(0,i.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types"},"Swift's Codable")),(0,i.kt)("p",null,"This is a reasonable first approximation, however, much of the function of the Feature Manifest is to provide a ",(0,i.kt)("em",{parentName:"p"},"default configuration")," for a feature, which is provided when one is not provided by the experiment."),(0,i.kt)("h3",{id:"json-merge-patch"},"JSON Merge Patch"),(0,i.kt)("p",null,"For each feature, the feature manifest should define a complete configuration needed by the app, including a default value for every variable."),(0,i.kt)("p",null,"Remotely set experiments and rollouts will vary the configurations by presenting ",(0,i.kt)("em",{parentName:"p"},"patches")," on that configuration. If the complete configuration of the feature can be represented by a JSON object, then patches to that configuration would be applied in a manner consistent with ",(0,i.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7396"},"JSON Merge Patch RFC 7396"),"."),(0,i.kt)("h3",{id:"about-the-generated-code"},"About the generated code"),(0,i.kt)("p",null,"Each project has one or more manifest file, containing all the features configured in that project."),(0,i.kt)("p",null,"Running ",(0,i.kt)("inlineCode",{parentName:"p"},"nimbus-fml")," for a manifest generates a Swift or Kotlin class, which is named as a command line argument."),(0,i.kt)("p",null,"In the examples, this class is called ",(0,i.kt)("inlineCode",{parentName:"p"},"FxNimbus"),", but this is project specific. This is the entry point to getting values out of Nimbus."),(0,i.kt)("p",null,"The generated class must be connected to the Nimbus SDK, which downloads the experiment recipes and decides which experiments this user is in."),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"// Initialize the Nimbus SDK\nlet nimbus = createNimbusForApplication()\n// Connect the generated code to the Nimbus SDK\nFxNimbus.shared.initialize { nimbus }\n"))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"// Initialize the Nimbus SDK\nval nimbus = createNimbusForApplication()\n// Connect the generated code to the Nimbus SDK\nFxNimbus.initialize { nimbus }\n")))),(0,i.kt)("p",null,"Feature configuration for each feature are accessed through the ",(0,i.kt)("inlineCode",{parentName:"p"},"FxNimbus.features")," property. For example, a ",(0,i.kt)("inlineCode",{parentName:"p"},"newtab")," feature's configuration can be accessed thus:"),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"let newTabConfig = FxNimbus.features.newtab.value()\n"))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"val newTabConfig = FxNimbus.features.newtab.value()\n")))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Details:\nWhen the ",(0,i.kt)("inlineCode",{parentName:"p"},"value()")," method is called:"),(0,i.kt)("ul",{parentName:"blockquote"},(0,i.kt)("li",{parentName:"ul"},"the Nimbus ",(0,i.kt)("inlineCode",{parentName:"li"},"api")," is queried to get a JSON object for the feature with id of ",(0,i.kt)("inlineCode",{parentName:"li"},"newtab")),(0,i.kt)("li",{parentName:"ul"},"the result is used to construct an instance of ",(0,i.kt)("inlineCode",{parentName:"li"},"Newtab"),", which is generated by the FML"),(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("inlineCode",{parentName:"li"},"Newtab")," object merges its default values with the values from the JSON."),(0,i.kt)("li",{parentName:"ul"},"this object is cached in memory for the next time this is called."),(0,i.kt)("li",{parentName:"ul"},"the cache is cleared each time the ",(0,i.kt)("inlineCode",{parentName:"li"},"applyPendingExperiments()")," method is called."))),(0,i.kt)("h3",{id:"recording-exposure"},"Recording exposure"),(0,i.kt)("p",null,"You should record when the user has been exposed to the feature. For example, if the feature being configured are the items in the ",(0,i.kt)("inlineCode",{parentName:"p"},"app-menu"),", then when the user ",(0,i.kt)("em",{parentName:"p"},"opens")," the app menu, you should call ",(0,i.kt)("inlineCode",{parentName:"p"},"recordExposure"),"."),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"FxNimbus.shared.features.appMenu.recordExposure()\n"))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"FxNimbus.features.appMenu.recordExposure()\n")))),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"Feature design hint:\nAs a rule of thumb, if you find yourself calling ",(0,i.kt)("inlineCode",{parentName:"p"},"recordExposure")," for the same feature in multiple places, you probably should rethink\nwhat the feature actually is.\ne.g. an ",(0,i.kt)("inlineCode",{parentName:"p"},"app-menu")," may have a hamburger menu icon, and some menu items.\nThe user is exposed to the hamburger menu icon every time the toolbar is shown, but the menu items only when the menu is opened.\nThis would suggest that the hamburger menu icon needs to be specified in a different feature, e.g. the ",(0,i.kt)("inlineCode",{parentName:"p"},"toolbar")," feature.")),(0,i.kt)("h3",{id:"identifier-cases"},"Identifier cases"),(0,i.kt)("p",null,"All the examples below use ",(0,i.kt)("inlineCode",{parentName:"p"},"kebab-case")," for identifiers. When these identifiers are used to generate code, they are transformed to the language-specific casing. For example, a feature is specified in the FML as being called ",(0,i.kt)("inlineCode",{parentName:"p"},"spotlight-search"),", but would be referred to in Swift as ",(0,i.kt)("inlineCode",{parentName:"p"},"spotlightSearch"),"."),(0,i.kt)("h2",{id:"introducing-the-fml"},"Introducing the FML"),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"/fml/fml-front-end-format"},"Feature Manifest Language is a dialect of YAML"),". The manifest file, say ",(0,i.kt)("inlineCode",{parentName:"p"},"nimbus.fml.yaml")," must be valid YAML."),(0,i.kt)("p",null,"YAML was chosen, in part, because it allows comments, there are many high quality parsers, and is a superset of JSON; JSON is used extensively in the configuration of features."),(0,i.kt)("p",null,"At a minimum the ",(0,i.kt)("inlineCode",{parentName:"p"},"nimbus.fml.yaml")," file defines some data about the generated file, a list of the channels and a map of features."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"# A YAML file to define Nimbus features.\n# This file has zero features.\nabout:\n  ios:\n    class: FxNimbus\n    module: Blockzilla\n  android:\n    class: .nimbus.FxNimbus\n    package: org.mozilla.focus\nchannels:\n  - developer\n  - nightly\n  - release\nfeatures: {}\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"about")," block must contain either an ",(0,i.kt)("inlineCode",{parentName:"p"},"ios")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"android")," object property."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"channels")," list is a list of strings containing one or more strings as build variants, or ",(0,i.kt)("inlineCode",{parentName:"p"},"channel"),"s."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"features")," property is a mapping of feature-id to feature. Feature IDs need to be valid strings. In this document all feature IDs are ",(0,i.kt)("inlineCode",{parentName:"p"},"kebab-cased")," in the manifest."),(0,i.kt)("p",null,"Adding features to this object will automatically be picked up by Experimenter."),(0,i.kt)("p",null,"They are converted to ",(0,i.kt)("inlineCode",{parentName:"p"},"mixedCamelCase")," in both Kotlin and Swift."),(0,i.kt)("h3",{id:"features-have-variables"},"Features have ",(0,i.kt)("inlineCode",{parentName:"h3"},"variables")),(0,i.kt)("p",null,"We start with an example which configures the integration between Firefox for iOS and iOS Spotlight feature."),(0,i.kt)("p",null,"Here, we define a feature with an id of ",(0,i.kt)("inlineCode",{parentName:"p"},"spotlight-search"),", with two variables\u2014 ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"max-age-in-days")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"features:\n  spotlight-search:\n    description: Configuring how we integrate web-pages with iOS's Spotlight search\n    variables:\n      enabled:\n        description: If `false`, the app will not record anything with Spotlight.\n        type: Boolean\n        default: false\n      max-age-in-days:\n        description: The number of days a single piece of content is indexed for.\n        type: Double\n        default: 28.0\n")),(0,i.kt)("p",null,"Each variable has a ",(0,i.kt)("inlineCode",{parentName:"p"},"description"),", a ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," value."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"description")," is copied verbatim into the generated code as comments. This will be visible in Xcode and Android Studio when navigating code or code completions."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"type")," is the type name or type label that the variable will be. The type labels for variables will be familiar to developers who have written Kotlin, Swift or Typescript. The ",(0,i.kt)("a",{parentName:"p",href:"#additional-types"},"different types of types are discussed in detail below"),"."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," value is used when the variable is not set remotely, or there is a problem within the SDK."),(0,i.kt)("p",null,"The default value has to make sense in the context of the variable's type."),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"let spotlightConfig = FxNimbus.features.spotlightSearch.value()\nguard spotlightConfig.enabled else {\n    return\n}\n\n// let item = CSSearchableItem(\u2026)\n\nlet oneDayInSeconds: TimeInterval = 24 * 60 * 60\nlet maxAgeInSeconds = Double(spotlightConfig.maxAgeInDays) * oneDayInSeconds\nitem.expirationDate = Date(timeIntervalSinceNow: maxAgeInSeconds)\n"))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"val spotlightConfig = FxNimbus.features.spotlightSearch.value()\nif (!spotlightConfig.enabled) {\n    return\n}\n\n// val item = SearchableItem(\u2026)\n\nval oneDayInSeconds: Int = 24 * 60 * 60\nval maxAgeInSeconds = spotlightConfig.maxAgeInDays * oneDayInSeconds\nitem.expirationDate = Date().addSeconds(maxAgeInSeconds)\n")))),(0,i.kt)("p",null,"Notice that:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the feature configuration is accessible from ",(0,i.kt)("inlineCode",{parentName:"li"},"FxNimbus.features.spotlightSearch.value()")),(0,i.kt)("li",{parentName:"ul"},"the feature id and variable names have been transformed to the Swift formatting convention; in this case both to mixed-camel-case."),(0,i.kt)("li",{parentName:"ul"},"the values consumed by Swift are non-optional.")),(0,i.kt)("p",null,"The generated code includes the defaults. It does not need to call into the Nimbus runtime or access the network."),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},'struct SpotlightSearch {\n    private let variables: Variables?\n\n    init(variables: Variables? = nil) {\n        self.variables = variables\n    }\n\n    lazy var enabled: Boolean = {\n        self.variables?.getBool("enabled") ?? false\n    }()\n\n    lazy var keepNumDays: Double = {\n        self.variables?.getDouble("enabled") ?? 28.0\n    }()\n}\n'))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},'data class SpotlightSearch(private val variables: Variables? = null) {\n    var enabled: Boolean by lazy {\n        self.variables?.getBool("enabled") ?? false\n    }\n\n    var keepNumDays: Double by lazy {\n        self.variables?.getDouble("enabled") ?? 28.0\n    }\n}\n')))),(0,i.kt)("p",null,"Variables are evaluated lazily."),(0,i.kt)("h3",{id:"enumerations"},"Enumerations"),(0,i.kt)("p",null,"Using the same ",(0,i.kt)("inlineCode",{parentName:"p"},"spotlight-search")," feature from above. We notice that the we can include an icon in the search results."),(0,i.kt)("p",null,"However, we have some options around what to include, but we're not sure which is best."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'features:\n  spotlight-search:\n    description: "Configuring how we integrate web-pages with iOS\'s Spotlight search"\n    variables:\n      # \u2026 other variables omitted for clarity\n      item-thumbnail:\n        description: "The icon that appears in the Spotlight search results.\n          Note that changing this does not change already indexed content."\n        type: ThumbnailType\n        default: letter\nenums:\n  ThumbnailType:\n    description: An enum of types of icon that can be presented alongside titles of pages\n    variants:\n      letter: A rendering of the first letter of the domain name\n      screenshot: A screenshot thumbnail of the webpage\n      favicon: The favicon derived from the webpage\n      none: No icon is displayed\n')),(0,i.kt)("p",null,"The value ",(0,i.kt)("inlineCode",{parentName:"p"},"itemThumbnail")," is of type ",(0,i.kt)("inlineCode",{parentName:"p"},"ThumbnailType"),", which is generated as an enum. This can be used exhaustively matched in a ",(0,i.kt)("inlineCode",{parentName:"p"},"switch")," statement."),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-swift"},"switch spotlightConfig.itemThumbnail {\n    case .favicon:\n        item.thumbnailData = FaviconFetcher.getFaviconFromDiskCache(imageKey: baseDomain)?.pngData()\n    case .letter:\n        item.thumbnailData = FaviconFetcher.letter(forUrl: url).pngData()\n    case .screenshot:\n        item.thumbnailData = tab.screenshot?.pngData()\n    case .none:\n        item.thumbnailData = nil\n}\n"))),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"item.thumbnail = when (spotlightConfig.itemThumbnail) {\n    ThumbnailType.FAVICON ->\n        FaviconFetcher.getFaviconFromDiskCache(imageKey: baseDomain)\n    ThumbnailType.LETTER -> FaviconFetcher.letter(forUrl: url)\n    ThumbnailType.SCREENSHOT -> tab.screenshot\n    ThumbnailType.NONE -> null\n}\n")))),(0,i.kt)("p",null,"Note: this Spotlight API doesn't exist on Android; this code is illustrating the enums on the lefthand side of the ",(0,i.kt)("inlineCode",{parentName:"p"},"case")," clauses in the ",(0,i.kt)("inlineCode",{parentName:"p"},"when")," expression."),(0,i.kt)("p",null,"Note that enumeration variants in Swift are in ",(0,i.kt)("inlineCode",{parentName:"p"},"mixedCamelCase"),"; in Kotlin they are in ",(0,i.kt)("inlineCode",{parentName:"p"},"SCREAMING_SNAKE_CASE"),"."),(0,i.kt)("h2",{id:"feature-defaults"},"Feature defaults"),(0,i.kt)("p",null,"Already, in this simple example we have three variables. We may want to vary the configuration of the feature when the user is not involved in an experiment."),(0,i.kt)("p",null,"This might be because we have run an experiment and learned that a change of configuration should be made more permanent."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"defaults"),' list is a list of zero or more "default blocks", used to patch the default values of the variables in a feature.'),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"value")," property defines the patch which is overlaid on top of the existing variable values."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'features:\n  spotlight-search:\n    variables:\n      enabled:\n        description: If `false`, the app will not record anything with Spotlight.\n        type: Boolean\n        default: false\n      max-age-in-days:\n        description: The number of days a single piece of content is indexed for.\n        type: Double\n        default: 28.0\n      item-thumbnail:\n        description: "The icon that appears in the Spotlight search results.\n          Note that changing this does not change already indexed content."\n        type: ThumbnailType\n        default: letter\n    defaults:\n      - value: { item-thumbnail: screenshot, max-age-in-days: 56.0 }\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"defaults")," list of ",(0,i.kt)("inlineCode",{parentName:"p"},"value"),"s set the default value of ",(0,i.kt)("inlineCode",{parentName:"p"},"item-thumbnail")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"screenshot"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"max-age-in-days")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"56.0"),"."),(0,i.kt)("p",null,"Adding new feature blocks to the ",(0,i.kt)("inlineCode",{parentName:"p"},"defaults")," list patches the existing defaults further:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"    defaults:\n      - value: { item-thumbnail: screenshot, max-age-in-days: 56.0 }\n      - value: { max-age-in-days: 64.0 }\n")),(0,i.kt)("p",null,"In this case, the default value for ",(0,i.kt)("inlineCode",{parentName:"p"},"item-thumbnail")," is now ",(0,i.kt)("inlineCode",{parentName:"p"},"screenshot"),", and ",(0,i.kt)("inlineCode",{parentName:"p"},"max-age-in-days")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"64.0"),"."),(0,i.kt)("h3",{id:"feature-defaults-and-channels"},"Feature defaults and channels"),(0,i.kt)("p",null,"Sometimes it is useful to have different default configurations for different ",(0,i.kt)("em",{parentName:"p"},"channels")," of an application. For example, you may want to have a feature available for testing on Nightly or Beta before turning it on in Release."),(0,i.kt)("p",null,"This is achieved by declaring ",(0,i.kt)("inlineCode",{parentName:"p"},"channels")," in the manifest."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'channels:\n  - nightly\n  - beta\n  - release\nfeatures:\n  spotlight-search:\n    variables:\n      enabled:\n        description: "\u2026"\n        type: Boolean\n        default: false\n    defaults:\n      - channel: nightly\n        value: { enabled: true }\n')),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"channel")," property specifies which build flavour the default applies. In this example, the ",(0,i.kt)("inlineCode",{parentName:"p"},"nightly")," version of the app set the ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," variable to ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),"; all other versions of the app have ",(0,i.kt)("inlineCode",{parentName:"p"},"enabled")," as ",(0,i.kt)("inlineCode",{parentName:"p"},"false"),"."),(0,i.kt)("p",null,"In this way, app developers can use the feature manifest as a replacement for other more adhoc feature flag solutions."),(0,i.kt)("h2",{id:"additional-types"},"Additional types"),(0,i.kt)("h3",{id:"primitive-types"},"Primitive types"),(0,i.kt)("p",null,"Primitive types supported:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"String")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Boolean"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Int"),".")),(0,i.kt)("h3",{id:"bundle-types"},"Bundle types"),(0,i.kt)("p",null,"Strings that can be coerced to resources within the bundle; however they are error prone to type in the Experimenter interface."),(0,i.kt)("p",null,"Suggested values can be used to suggest values to the experiment owner, with a description on what the resource will look like."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Text")," performs a lookup for displayable text in the application bundle. If not text exists, returns the string used for lookup."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Image")," performs a lookup for an image in the application bundle.")),(0,i.kt)("p",null,"For each of these types, the default value ",(0,i.kt)("em",{parentName:"p"},"must")," correspond to a valid resource identifier in the app."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"features:\n    upgrade-message:\n        description: A message displayed when the user upgrades\n        variables:\n            hero-image:\n                description: A pre-bundled image\n                type: Image\n                default: ic_fox\n            message-content:\n                description: Text content to show the user\n                default: msg_thankyou\n")),(0,i.kt)(d,{defaultValue:"swift",values:[{label:"Swift",value:"swift"},{label:"Kotlin",value:"kotlin"}],mdxType:"Tabs"},(0,i.kt)(m,{value:"swift",mdxType:"TabItem"},"Values for `Text` are strings which must correspond to the following format:",(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"KEY")," |\n",(0,i.kt)("inlineCode",{parentName:"p"},"TABLE_NAME")," '",(0,i.kt)("inlineCode",{parentName:"p"},"/"),"' ",(0,i.kt)("inlineCode",{parentName:"p"},"KEY")),(0,i.kt)("p",null,"The lookup uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"bundle.localizedString(forKey: key, value: nil, table: tableName)")," method."),(0,i.kt)("p",null,"If the text is not found, then the raw string is used instead."),(0,i.kt)("p",null,"For ",(0,i.kt)("inlineCode",{parentName:"p"},"Image"),", they should correspond to an image named in an asset bundle, and use the ",(0,i.kt)("inlineCode",{parentName:"p"},"UIImage(named: name, in: bundle, compatibleWith: nil)")," constructor.")),(0,i.kt)(m,{value:"kotlin",mdxType:"TabItem"},(0,i.kt)("p",null,"Values for ",(0,i.kt)("inlineCode",{parentName:"p"},"Text")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"Image")," are strings which must correspond to the following format:"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"[a-z][a-z_0-9]*")),(0,i.kt)("p",null,"The lookup uses the ",(0,i.kt)("inlineCode",{parentName:"p"},"R")," class."),(0,i.kt)("p",null,"Android uses integer identifiers stored in the ",(0,i.kt)("inlineCode",{parentName:"p"},"R")," class. Sometimes these identifiers are what is required."),(0,i.kt)("p",null,"In the above example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-kotlin"},"val heroImage = FxNimbus.features.upgradeMessage.value().heroImage\nval resId: Int = heroImage.resourceId\nval image: Drawable = heroImage.resource\n")))),(0,i.kt)("hr",null),(0,i.kt)("p",null,"For ",(0,i.kt)("inlineCode",{parentName:"p"},"Text")," strings, if the text key does not resolve to a localized string, the key itself is used as a string."),(0,i.kt)("h3",{id:"object-types"},"Object types"),(0,i.kt)("p",null,"Some features require more organization. In the case, JSON Objects can be coerced into generated data classes."),(0,i.kt)("p",null,"Object types have fields in the same way features have variables. Objects can be used in multiple places, and in more than one feature."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"features:\n  dialog-appearance:\n    description: A feature to vary the appearance of all toasts and modal dialogs\n    variables:\n      positive-button:\n        type: ButtonAppearance\n        default:\n          background-color: blue\n          text-color: white\n      neutral-button:\n        type: ButtonAppearance\n        default: {}\n      negative-button:\n        type: ButtonAppearance\n        default:\n          text-color: white\n          background-color: red\nobjects:\n  ButtonAppearance:\n    description: A button used in dialogs throughout the app\n    fields:\n      text-color:\n        description: The color of the text\n        type: String\n        default: black\n      background-color:\n        description: The background color\n        type: String\n        default: gray\n")),(0,i.kt)("p",null,"The JSON to recreate the defaults for the feature above would be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "positive-button": {\n    "text-color": "blue",\n    "background-color": "white"\n  },\n  "neutral-button": {\n    "text-color": "black",\n    "background-color": "gray"\n  },\n  "negative-button": {\n    "text-color": "red",\n    "background-color": "white"\n  }\n}\n')),(0,i.kt)("h3",{id:"structural-types"},"Structural types"),(0,i.kt)("p",null,"Generic types aren't supported, but in the following section, ",(0,i.kt)("inlineCode",{parentName:"p"},"T")," can be any other type supported by the FML, including structural types."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Option<T>")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"T?")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"List<T>")," - lists of type ",(0,i.kt)("inlineCode",{parentName:"li"},"T"),". Lists are encoded with JSON arrays.\nLists are not merged, so are less useful than you might think."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Map<K, V>")," \u2014 maps with key type ",(0,i.kt)("inlineCode",{parentName:"li"},"K")," to ",(0,i.kt)("inlineCode",{parentName:"li"},"V"),".")),(0,i.kt)("p",null,"Maps are transported as JSON objects, which restrict the types of the keys to types that can be coerced from ",(0,i.kt)("inlineCode",{parentName:"p"},"String"),"s. Additionally, JSON values that cannot be coerced to the value type of the map are discarded."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"features:\n  homepage:\n    variables:\n      sections-enabled:\n        description: A map of whether or not to display the sections.\n        type: Map<SectionId, Boolean>\n        default:\n          top-sites: true\n          jump-back-in: false\n          pocket: false\n          recently-saved: false\n          recent-searches: false\n      section-ordering:\n        description: The order that the sections appear in on the homescreen.\n        type: List<SectionId>\n        value:\n          - jump-back-in\n          - pocket\n          - recently-saved\n          - recent-searches\n    defaults:\n      - channel: nightly\n        value:\n          {\n            top-sites: true,\n            jump-back-in: true,\n            recently-saved: true,\n            recent-searches: true,\n            pocket: true,\n          }\nenums:\n  SectionId:\n    description: An enum representing the sections enabled by the homepage.\n    variants:\n      top-sites:\n        Frecency based URLs\n      jump-back-in:\n        Tabs which the user was interrupted while reading.\n      pocket:\n        URLs from the Pocket homepage\n      recently-saved:\n        URLs which were recently bookmarked or saved to Pocket\n      recent-searches:\n        Search queries and their opened results.\n")),(0,i.kt)("p",null,"In this example, a ",(0,i.kt)("inlineCode",{parentName:"p"},"Map<SectionId, Boolean>")," is used. ",(0,i.kt)("inlineCode",{parentName:"p"},"SectionId")," is an enum."),(0,i.kt)("p",null,"Maps with enum keys must have a default value for every variant of the enum."),(0,i.kt)("p",null,"Since maps are backed by JSON objects, the merge/patching allows entries to come from the manifest, experiments and rollouts simultaneously."),(0,i.kt)("h2",{id:"merging-other-fml-files-into-this-one"},"Merging other FML files into this one"),(0,i.kt)("p",null,"This ",(0,i.kt)("inlineCode",{parentName:"p"},"include")," property is a list of files which will be merged with this one. The files may be relative to this one, absolute or URLs."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"include:\n    - nimbus/search.yaml\n    - @mozilla/nimbus-shared/fml/messaging.yaml\n")),(0,i.kt)("p",null,"Notice the ",(0,i.kt)("inlineCode",{parentName:"p"},"@")," in the second entry: by default this will be interpreted as a GitHub repository, with the file path on the ",(0,i.kt)("inlineCode",{parentName:"p"},"main")," branch. More about ",(0,i.kt)("a",{parentName:"p",href:"/fml/fml-paths"},"using ",(0,i.kt)("inlineCode",{parentName:"a"},"@")," paths here"),"."),(0,i.kt)("p",null,"In this example, two files are merged into this one: the ",(0,i.kt)("inlineCode",{parentName:"p"},"features"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"enums")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"objects")," from each are added to the corresponding objects in this one."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/fml/fml-imports-and-includes#the-include-list"},"More")),(0,i.kt)("h2",{id:"linking-files-from-other-components"},"Linking files from other components"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"import")," list is a list of objects referencing other FML files from other components. The code generated from those files are generated at build time of those components, with their own channels and configurations."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"import:\n    - path:    ../Accounts/nimbus.fml.yaml\n      channel: production\n    - path:    @mozilla-mobile/ios-components/components/feature/search/nimbus.fml.yaml\n      channel: release\n")),(0,i.kt)("p",null,"The list contains blocks with the following mandatory properties:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"path"),": this string value is a relative path or URL to the imported file."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"channel"),": this string value is the name of a channel. The channel ",(0,i.kt)("strong",{parentName:"li"},"must")," be in the channel list of the included file.")),(0,i.kt)("p",null,"An imported file:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"must")," have an ",(0,i.kt)("inlineCode",{parentName:"li"},"about")," block."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"may")," have an ",(0,i.kt)("inlineCode",{parentName:"li"},"include")," block.")),(0,i.kt)("p",null,"Optionally, a ",(0,i.kt)("inlineCode",{parentName:"p"},"features")," block is provided, which is a ",(0,i.kt)("inlineCode",{parentName:"p"},"Map<FeatureId, List<DefaultBlock>>"),". This provides a way of providing app specific configuration to already built components."),(0,i.kt)("p",null,"A list of ",(0,i.kt)("inlineCode",{parentName:"p"},"DefaultBlock"),"s is the same way feature defaulting, and channel specific defaulting works when specifying a feature."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"import:\n    - path:    ../Accounts/nimbus.fml.yaml\n      channel: production\n      features:\n        accounts:\n            - value:\n                button-color: blue\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"value")," used by the imported code will come from the importing code."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/fml/fml-imports-and-includes#the-import-list"},"More")),(0,i.kt)("h2",{id:"additional-feature-specific-configuration"},"Additional feature specific configuration"),(0,i.kt)("h3",{id:"links-to-documentation-and-contacts"},"Links to documentation and contacts"),(0,i.kt)("p",null,"In order to drive a better experience for ",(0,i.kt)("inlineCode",{parentName:"p"},"experimenter")," (the Nimbus web server), a number of extra optional fields are needed. See ",(0,i.kt)("a",{parentName:"p",href:"/fml/feature-metadata"},"Providing feature metadata")," for more."),(0,i.kt)("h3",{id:"feature-co-enrollment"},"Feature co-enrollment"),(0,i.kt)("p",null,"A feature which allows co-enrollment allows a client to be enrolled in any number of experiments/rollouts for that feature. See ",(0,i.kt)("a",{parentName:"p",href:"/fml/coenrolling-features"},"Co-enrolling Features")," for more information."))}f.isMDXComponent=!0}}]);